@model WebApplication2.Models.ViewModel.TrainingDetailViewModel
@{
    ViewData["Title"] = Model?.Training?.Title + " - Training Details";
    Layout = "_Layout";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Training Details</h1>
            <p class="text-muted mb-0">@Model?.Training?.Title - @Model?.Employee?.FirstName @Model?.Employee?.LastName</p>
        </div>
        <div>
            <a href="@Url.Action("Details", "Employee", new { id = Model?.Employee?.Id })" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-1"></i>Back to Employee
            </a>
        </div>
    </div>

    @if (Model != null && Model.Training != null)
    {
        <div class="row">
            <!-- Training Header & Basic Info -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Training Information</h5>
                        <span class="badge @GetTrainingStatusBadge(Model.Training.Status)">@Model.Training.Status</span>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-12">
                                <h2 class="text-primary">@Model.Training.Title</h2>
                                <p class="lead">@Model.Training.Provider</p>
                                @if (!string.IsNullOrEmpty(Model.Training.Description))
                                {
                                    <div class="mt-3 p-3 bg-light rounded">
                                        <h6>Description:</h6>
                                        <p class="mb-0">@Model.Training.Description</p>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <dl>
                                    <dt>Employee:</dt>
                                    <dd>
                                        <strong>@Model.Employee.FirstName @Model.Employee.LastName</strong><br>
                                        <small class="text-muted">@Model.Employee.Position - @Model.Employee.Department</small>
                                    </dd>

                                    <dt>Training Period:</dt>
                                    <dd>
                                        @Model.Training.StartDateDateTime().ToString("MMM dd, yyyy") -
                                        @Model.Training.EndDateDateTime().ToString("MMM dd, yyyy")<br>
                                        <small class="text-muted">@Model.DurationDays days duration</small>
                                    </dd>

                                    <dt>Assigned Reason:</dt>
                                    <dd>@(string.IsNullOrEmpty(Model.Training.AssignedReason) ? "Not specified" : Model.Training.AssignedReason)</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl>
                                    @* <dt>Skill Gap Analysis:</dt>
                                    <dd>
                                        <div class="progress mb-2" style="height: 20px;">
                                            <div class="progress-bar bg-danger" style="width: @(Model.Training.SkillGapBefore * 20)%">
                                                Before: @Model.Training.SkillGapBefore
                                            </div>
                                        </div>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-success" style="width: @(Model.Training.SkillGapAfter * 20)%">
                                                After: @Model.Training.SkillGapAfter
                                            </div>
                                        </div>
                                        <small class="text-muted">Improvement: @Model.SkillImprovement</small>
                                    </dd> *@

                                    <dt>Certificate:</dt>
                                    <dd>
                                        @if (Model.HasCertificate)
                                        {
                                            <div>
                                                @if (!string.IsNullOrEmpty(Model.Training.CertificatePdfUrl))
                                                {
                                                    <a href="@Model.Training.CertificatePdfUrl" target="_blank" class="btn btn-sm btn-outline-success">
                                                        <i class="bi bi-file-earmark-pdf me-1"></i>View PDF Certificate
                                                    </a>
                                                }
                                                else if (!string.IsNullOrEmpty(Model.Training.CertificateUrl))
                                                {
                                                    <a href="@Model.Training.CertificateUrl" target="_blank" class="btn btn-sm btn-outline-success">
                                                        <i class="bi bi-file-earmark-text me-1"></i>View Certificate
                                                    </a>
                                                }
                                                @if (!string.IsNullOrEmpty(Model.Training.CertificateFileName))
                                                {
                                                    <br>
                                        
                                                    <small class="text-muted">File: @Model.Training.CertificateFileName</small>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">No certificate available</span>
                                        }
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats & Actions -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Training Metrics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="metric-item">
                                    <div class="h4 text-primary">@Model.CoveredSkills.Count</div>
                                    <small class="text-muted">Skills Covered</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="metric-item">
                                    <div class="h4 text-success">@Model.DurationDays</div>
                                    <small class="text-muted">Duration Days</small>
                                </div>
                            </div>
                            @* <div class="col-6">
                                <div class="metric-item">
                                    <div class="h4 text-info">@Model.Training.SkillGapBefore</div>
                                    <small class="text-muted">Gap Before</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="metric-item">
                                    <div class="h4 text-warning">@Model.Training.SkillGapAfter</div>
                                    <small class="text-muted">Gap After</small>
                                </div>
                            </div> *@
                        </div>
                    </div>
                </div>

                <!-- Status Timeline -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Training Timeline</h5>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            <div class="timeline-item @(Model.Training.IsCompleted() || Model.Training.IsInProgress() || Model.Training.IsAssigned() || Model.Training.IsPending() ? "active" : "")">
                                <div class="timeline-point"></div>
                                <div class="timeline-content">
                                    <small>Assigned</small>
                                    <p class="mb-0">@Model.Training.CreatedAtDateTime().ToString("MMM dd, yyyy")</p>
                                </div>
                            </div>
                            <div class="timeline-item @(Model.Training.IsCompleted() || Model.Training.IsInProgress() ? "active" : "")">
                                <div class="timeline-point"></div>
                                <div class="timeline-content">
                                    <small>Started</small>
                                    <p class="mb-0">@Model.Training.StartDateDateTime().ToString("MMM dd, yyyy")</p>
                                </div>
                            </div>
                            <div class="timeline-item @(Model.Training.IsCompleted() ? "active" : "")">
                                <div class="timeline-point"></div>
                                <div class="timeline-content">
                                    <small>Completed</small>
                                    <p class="mb-0">@Model.Training.EndDateDateTime().ToString("MMM dd, yyyy")</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="@Url.Action("DebugTrainingData", "Training", new { employeeId = Model.Employee.Id, trainingId = Model.Training.Id })"
                               class="btn btn-outline-info btn-sm" target="_blank">
                                <i class="bi bi-bug me-1"></i>Debug Data
                            </a>
                            <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                                <i class="bi bi-printer me-1"></i>Print Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Skills Coverage -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Skills Covered by Training</h5>
                        <span class="badge bg-primary">@Model.CoveredSkills.Count skills</span>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        @if (Model.CoveredSkills.Any())
                        {
                            foreach (var skill in Model.CoveredSkills)
                            {
                                <div class="mb-3 p-3 border rounded">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <strong class="text-primary">@skill.Name</strong>
                                        <span class="badge @GetSkillLevelClass(skill.Level)">
                                            @skill.LevelDescription()
                                        </span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="bi bi-tags me-1"></i>Category: @skill.Category<br />
                                            @if (skill.YearsOfExperience > 0)
                                            {
                                                <text><i class="bi bi-clock me-1"></i>Experience: @skill.YearsOfExperience years<br /></text>
                                            }
                                            <i class="bi bi-person me-1"></i>Current Level: @skill.Level
                                        </small>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="bi bi-tools text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-2">No specific skills listed for this training</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Employee's Related Skills</h5>
                        <span class="badge bg-info">@Model.EmployeeSkills.Count total</span>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        @if (Model.EmployeeSkills.Any())
                        {
                            foreach (var skill in Model.EmployeeSkills.Take(10))
                            {
                                <div class="mb-2 p-2 border rounded @(Model.CoveredSkills.Any(s => s.Name == skill.Name) ? "border-success bg-success bg-opacity-10" : "")">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>@skill.Name</span>
                                        <div>
                                            <span class="badge @GetSkillLevelClass(skill.Level)">@skill.Level</span>
                                            @if (Model.CoveredSkills.Any(s => s.Name == skill.Name))
                                            {
                                                <span class="badge bg-success ms-1">Covered</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                            @if (Model.EmployeeSkills.Count > 10)
                            {
                                <div class="text-center mt-2">
                                    <small class="text-muted">and @(Model.EmployeeSkills.Count - 10) more skills...</small>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="bi bi-tools text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-2">No skills recorded for this employee</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Qualifications -->
        @if (Model.RelatedQualifications.Any())
        {
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Related Qualifications</h5>
                            <span class="badge bg-success">@Model.RelatedQualifications.Count qualifications</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                @foreach (var qual in Model.RelatedQualifications)
                                {
                                    <div class="col-md-6 mb-3">
                                        <div class="p-3 border rounded">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <strong class="text-success">@qual.Degree</strong>
                                                <span class="badge bg-secondary">@qual.YearCompleted</span>
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="bi bi-building me-1"></i>@qual.Institution<br />
                                                    @if (!string.IsNullOrEmpty(qual.FieldOfStudy))
                                                    {
                                                        <text><i class="bi bi-book me-1"></i>Field: @qual.FieldOfStudy<br /></text>
                                                    }
                                                    @if (!string.IsNullOrEmpty(qual.Grade))
                                                    {
                                                        <text><i class="bi bi-award me-1"></i>Grade: @qual.Grade</text>
                                                    }
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <div class="mt-4 d-flex justify-content-between">
            <div>
                <a href="@Url.Action("Details", "Employee", new { id = Model.Employee.Id })" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to Employee
                </a>
            </div>
            <div>
                <small class="text-muted">
                    Training ID: @Model.Training.Id |
                    Last updated: @DateTime.Now.ToString("MMM dd, yyyy HH:mm")
                </small>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-danger">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle me-2" style="font-size: 1.5rem;"></i>
                <div>
                    <h5 class="alert-heading">Training Not Found</h5>
                    <p class="mb-0">The requested training could not be found. Please check the training ID and try again.</p>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <a href="@Url.Action("Index", "Employee")" class="btn btn-primary">
                <i class="bi bi-people me-1"></i>View All Employees
            </a>
        </div>
    }
</div>

@functions {
    public string GetSkillLevelClass(string level)
    {
        if (string.IsNullOrEmpty(level)) return "bg-secondary";

        var levelNum = ParseSkillLevel(level);
        return levelNum switch
        {
            1 => "bg-danger",
            2 => "bg-warning text-dark",
            3 => "bg-info",
            4 => "bg-primary",
            5 => "bg-success",
            _ => "bg-secondary"
        };
    }

    public string GetTrainingStatusBadge(string status)
    {
        return status?.ToLower() switch
        {
            "completed" => "bg-success",
            "in progress" => "bg-warning text-dark",
            "not started" => "bg-secondary",
            "cancelled" => "bg-danger",
            "assigned" => "bg-info",
            "pending" => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private int ParseSkillLevel(string level)
    {
        if (int.TryParse(level, out int result))
            return result;

        return level?.ToLower() switch
        {
            "beginner" => 1,
            "basic" => 2,
            "intermediate" => 3,
            "advanced" => 4,
            "expert" => 5,
            _ => 0
        };
    }
}

<style>
    .bg-purple {
        background-color: #6f42c1 !important;
    }

    .metric-item {
        padding: 10px;
    }

    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }

    .timeline {
        position: relative;
        padding-left: 20px;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }

    .timeline-point {
        position: absolute;
        left: -20px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #dee2e6;
        border: 2px solid #fff;
    }

    .timeline-item.active .timeline-point {
        background-color: #0d6efd;
    }

    .timeline-content {
        padding-left: 10px;
    }

    .border-rounded {
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        transition: all 0.2s ease-in-out;
    }

        .border-rounded:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
</style>